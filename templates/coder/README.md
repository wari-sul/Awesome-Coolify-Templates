# Coder - Cloud Development Environments

## Overview

This Docker Compose deploys **Coder**, an open-source platform for provisioning self-hosted development environments on your infrastructure. Coder enables you to create, manage, and access cloud-based development workspaces with consistent configurations across your team.

## What's Included

This template deploys a complete Coder installation with:

- **Coder Server**: Main application server that manages workspaces and user access
- **PostgreSQL 17**: Database for storing workspace configurations, user data, and audit logs
- **Docker Socket Access**: Allows Coder to create Docker-based workspaces on the host

## Architecture

```
Coder Stack:
├── Coder Server (port 7080)
│   ├── Manages development workspaces
│   ├── User authentication & authorization
│   ├── Web-based IDE access
│   └── Docker workspace provisioning
└── PostgreSQL 17 Database
    ├── Workspace configurations
    ├── User and authentication data
    └── Audit logs and metrics
```

## Prerequisites

### Required
- Coolify instance with Docker installed
- Domain or subdomain for accessing Coder (e.g., `coder.example.com`)
- Docker socket access (automatically configured in this template)

### Optional
- External authentication provider (OAuth, OIDC, SAML)
- External object storage for workspace backups
- Custom workspace templates

## Deployment Steps

### 1. Create New Service in Coolify

1. Navigate to your Coolify project
2. Click **New Resource** → **Docker Compose**
3. Paste the contents of `docker-compose.yaml`

### 2. Configure Environment Variables

#### Automatically Configured (Coolify Magic Variables)

```bash
# SERVICE_URL_CODER_7080
# - Automatically generated by Coolify
# - Provides the public URL for accessing Coder
# - Used as CODER_ACCESS_URL

# SERVICE_PASSWORD_POSTGRES
# - Automatically generated secure password by Coolify
# - Used for PostgreSQL authentication
```

#### Optional Variables (With Defaults)

```bash
# Image configuration
CODER_REPO=ghcr.io/coder/coder          # Docker registry for Coder image
CODER_VERSION=latest                     # Coder version (e.g., v2.7.0, latest)
```

### 3. Configure Domain in Coolify

1. In the Coolify service settings, go to **Domains**
2. Add your domain: `coder.example.com`
3. Coolify will automatically:
   - Generate the `SERVICE_URL_CODER_7080` variable
   - Handle SSL/TLS certificate provisioning
   - Configure reverse proxy to port 7080

### 4. Deploy

Click **Deploy** and wait for both services to start. The database will initialize first, then Coder will start once the database is healthy.

## Initial Setup

### First Login

After deployment, access Coder at your configured domain (e.g., `https://coder.example.com`):

1. **Create Admin Account**
   - The first user to access Coder becomes the admin
   - Navigate to your Coder URL
   - Create your admin account with email and password

2. **Configure Authentication** (Optional)
   - Go to **Deployment** → **User Authentication**
   - Configure OAuth, OIDC, or SAML if desired
   - Or continue with built-in authentication

3. **Create Your First Template**
   - Go to **Templates** → **Create Template**
   - Choose from starter templates or create custom ones
   - Templates define the development environment configuration

4. **Create a Workspace**
   - Go to **Workspaces** → **Create Workspace**
   - Select a template
   - Configure workspace parameters
   - Start the workspace

## Volume Management

The template uses two persistent volumes:

| Volume | Purpose | Path |
|--------|---------|------|
| `coder_data` | PostgreSQL database files | `/var/lib/postgresql/data` |
| `coder_home` | Coder application data and configurations | `/home/coder` |

> **Important**: The `/var/run/docker.sock` volume mount gives Coder access to the host's Docker daemon, allowing it to create and manage Docker-based workspaces.

## Usage Guide

### Creating Workspace Templates

Workspace templates define the development environment:

1. Navigate to **Templates** → **Create Template**
2. Choose a base template or start from scratch
3. Configure:
   - **Image**: Docker image for the workspace
   - **Resources**: CPU, memory, and disk allocations
   - **Applications**: Pre-installed tools and IDEs
   - **Startup Script**: Commands to run on workspace creation
4. Save and publish the template

### Managing Workspaces

Users can create workspaces from templates:

1. **Create**: Select template and configure parameters
2. **Start/Stop**: Control workspace lifecycle
3. **Access**: Use web IDE or SSH
4. **Update**: Apply template changes to existing workspaces
5. **Delete**: Remove workspaces when no longer needed

### Accessing Workspaces

Coder provides multiple access methods:

- **Web IDE**: Built-in code-server (VS Code in browser)
- **SSH**: Direct terminal access via SSH
- **VS Code Desktop**: Connect VS Code desktop app to workspace
- **JetBrains Gateway**: Connect JetBrains IDEs to workspace

## Configuration Options

### Environment Variables Reference

| Variable | Purpose | Default | Required |
|----------|---------|---------|----------|
| `SERVICE_URL_CODER_7080` | Public URL for Coder (auto-generated by Coolify) | - | Yes (auto) |
| `SERVICE_PASSWORD_POSTGRES` | PostgreSQL password (auto-generated by Coolify) | - | Yes (auto) |
| `CODER_REPO` | Docker image repository | `ghcr.io/coder/coder` | No |
| `CODER_VERSION` | Coder version tag | `latest` | No |
| `POSTGRES_USER` | PostgreSQL username | `coder` | No |
| `POSTGRES_DB` | PostgreSQL database name | `coder` | No |

### Additional Coder Configuration

Coder supports many additional environment variables for advanced configuration:

```bash
# Telemetry (optional - disable telemetry)
CODER_TELEMETRY_ENABLE=false

# Session duration (optional - default 24h)
CODER_SESSION_DURATION=24h

# Workspace inactivity timeout (optional)
CODER_MAX_WORKSPACE_INACTIVITY=8h

# Authentication (optional - configure external auth)
CODER_OIDC_ISSUER_URL=https://your-oidc-provider.com
CODER_OIDC_CLIENT_ID=your-client-id
CODER_OIDC_CLIENT_SECRET=your-client-secret
```

Add these to the `coder` service environment section if needed.

## Security Considerations

### Docker Socket Access

This template mounts `/var/run/docker.sock`, which gives Coder full access to Docker:

- **Required**: Coder needs this to create Docker-based workspaces
- **Risk**: Users with template editing permissions could potentially gain host access
- **Mitigation**: 
  - Restrict template creation/editing to trusted admins
  - Use RBAC to control permissions
  - Consider running Coder on a dedicated Docker host
  - Use Kubernetes instead of Docker for production deployments

### Database Security

- PostgreSQL password is auto-generated by Coolify
- Database is not exposed externally (internal service only)
- Ensure regular database backups

### Network Security

- Coder is exposed via Coolify's reverse proxy with TLS
- Workspaces can be configured with network policies
- Consider VPN or firewall rules for additional security

## Troubleshooting

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| "Database connection failed" | Database not ready or wrong credentials | Check database logs; verify `SERVICE_PASSWORD_POSTGRES` is set |
| "Cannot access Coder URL" | Domain not configured or SSL issue | Verify domain in Coolify; check SSL certificate provisioning |
| "Permission denied on Docker socket" | Docker socket not mounted or wrong permissions | Verify `/var/run/docker.sock` volume mount exists |
| "Workspace fails to start" | Docker resource limitations | Check host resources; increase Docker limits if needed |
| "First login doesn't create admin" | Database initialization issue | Check logs; may need to recreate service |

### Checking Logs

**Coder Service Logs:**
```bash
# In Coolify
Service → Logs → coder
```

**Database Logs:**
```bash
# In Coolify
Service → Logs → database
```

### Database Connection Test

To verify database connectivity:

1. Go to Coolify service logs for `coder`
2. Look for lines like:
   ```
   Successfully connected to database
   Running database migrations
   ```

### Port Verification

Coder should be listening on port 7080 internally:

```bash
# From Coder container
curl -f http://127.0.0.1:7080/
```

## Upgrading Coder

To upgrade to a new Coder version:

1. Update the `CODER_VERSION` environment variable
2. Redeploy the service in Coolify
3. Coder will automatically run database migrations
4. Verify all workspaces are accessible after upgrade

> **Note**: Always review the [Coder release notes](https://github.com/coder/coder/releases) before upgrading, especially for major version changes.

## Scaling Notes

### Single Instance Limitations

This template deploys a single Coder instance:

- **Concurrent Users**: 50-100 users per instance (varies by workspace size)
- **Workspaces**: Limited by host resources (CPU, RAM, disk)
- **High Availability**: Not available (single point of failure)

### Scaling Recommendations

For production deployments:

1. **Horizontal Scaling**: Deploy multiple Coder instances behind a load balancer
2. **Database**: Use managed PostgreSQL or a replicated setup
3. **Workspace Storage**: Use external storage (NFS, S3) for workspace persistence
4. **Kubernetes**: Consider Coder's Kubernetes deployment for better scaling

## Advanced Configuration

### External Authentication

Configure OAuth or OIDC for enterprise authentication:

```yaml
# Add to coder service environment
- CODER_OIDC_ISSUER_URL=https://auth.example.com
- CODER_OIDC_CLIENT_ID=coder-client
- CODER_OIDC_CLIENT_SECRET=your-secret
- CODER_OIDC_EMAIL_DOMAIN=example.com
```

### Workspace Templates

Create templates for different development stacks:

- **Frontend**: Node.js, npm, VS Code
- **Backend**: Python, pip, Django/Flask
- **Full Stack**: Node.js + PostgreSQL
- **Data Science**: Python, Jupyter, pandas, TensorFlow

### Resource Management

Configure workspace resource limits:

```yaml
# Add to coder service environment
- CODER_PROVISIONER_DAEMONS=3
- CODER_PROVISIONER_DAEMON_POLL_INTERVAL=1s
```

## Additional Resources

- **Official Documentation**: https://coder.com/docs
- **GitHub Repository**: https://github.com/coder/coder
- **Community Forum**: https://github.com/coder/coder/discussions
- **Template Gallery**: https://github.com/coder/coder/tree/main/examples/templates

## Success Criteria

After successful deployment, you should be able to:

- ✅ Access Coder web interface at your domain
- ✅ Create an admin account on first login
- ✅ Create workspace templates
- ✅ Launch workspaces from templates
- ✅ Access workspaces via web IDE or SSH
- ✅ Stop and start workspaces as needed

## Performance Tips

1. **SSD Storage**: Use SSD-backed volumes for better performance
2. **Resource Allocation**: Ensure host has sufficient CPU and RAM
3. **Workspace Limits**: Set appropriate resource limits per workspace
4. **Cleanup**: Regularly delete unused workspaces to free resources
5. **Monitoring**: Use Coder's built-in metrics to track usage

---

**Need Help?** Check the [Coder documentation](https://coder.com/docs) or open an issue in the repository!
